name: Uppdatera OmrÃ¥desparametrar

on:
  schedule:
    - cron: '0 1 * * *'  # KÃ¶r kl 02:00 svensk tid varje natt (01:00 UTC)
  workflow_dispatch:     # MÃ¶jliggÃ¶r manuell kÃ¶rning

jobs:
  update-area-parameters:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout fÃ¶r att undvika lÃ¥nga kÃ¶rningar

    steps:
      - name: ðŸ“¥ Klona repo
        uses: actions/checkout@v3

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Installera beroenden
        run: npm ci

      - name: ðŸŒŠ KÃ¶r fetchAreaParametersStructured.ts
        env:
          DMI_API_KEY: ${{ secrets.DMI_API_KEY }}
        run: npx tsx scripts/fetchAreaParametersStructured.ts

      - name: ðŸ“Š Kontrollera filstorlek
        run: |
          if [ -f "public/data/area-parameters.json.gz" ]; then
            FILE_SIZE=$(stat -c%s "public/data/area-parameters.json.gz")
            FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
            echo "Komprimerad filstorlek: ${FILE_SIZE_MB}MB"
            
            if [ $FILE_SIZE -gt 104857600 ]; then  # 100MB i bytes
              echo "âŒ Fil Ã¤r fÃ¶r stor (${FILE_SIZE_MB}MB > 100MB)"
              exit 1
            else
              echo "âœ… Filstorlek OK (${FILE_SIZE_MB}MB)"
            fi
          else
            echo "âŒ Komprimerad fil hittades inte"
            exit 1
          fi

      - name: ðŸ”„ Pusha uppdaterad data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/area-parameters.json.gz
          git add src/lib/loadAreaParameters.ts
          
          # Kontrollera om det finns Ã¤ndringar
          if git diff --staged --quiet; then
            echo "Inga Ã¤ndringar att commita"
          else
            git commit -m "ðŸŒŠ Auto-uppdaterade omrÃ¥desparametrar ($(date +'%Y-%m-%d %H:%M'))"
            git push
            echo "âœ… Data uppdaterad och pushad"
          fi

      - name: ðŸ“ Sammanfattning
        run: |
          echo "## ðŸŒŠ OmrÃ¥desparametrar uppdaterade" >> $GITHUB_STEP_SUMMARY
          echo "- **Tid**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Fil**: public/data/area-parameters.json.gz" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "public/data/area-parameters.json.gz" ]; then
            FILE_SIZE=$(stat -c%s "public/data/area-parameters.json.gz")
            FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
            echo "- **Storlek**: ${FILE_SIZE_MB}MB (komprimerad)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Status**: âœ… Klart" >> $GITHUB_STEP_SUMMARY 